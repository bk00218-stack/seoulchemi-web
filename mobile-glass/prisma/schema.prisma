// MobileGlass - 렌즈초이스 데이터베이스 스키마
// OlwsPro 기능 통합 버전

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 브랜드 테이블
model Brand {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 브랜드명 (케미, 하이텍, 진명 등)
  stockManage   String?   // 출고 관리 (바코드, 미사용)
  canExchange   Boolean   @default(false) // 교환 가능 여부
  canReturn     Boolean   @default(false) // 반품 가능 여부
  isActive      Boolean   @default(true)  // 상태 (사용/미사용)
  displayOrder  Int       @default(0)     // 노출순서
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  products      Product[]
}

// 상품 테이블
model Product {
  id              Int       @id @default(autoincrement())
  brandId         Int
  brand           Brand     @relation(fields: [brandId], references: [id])
  
  name            String    // 상품명 (1.56 착색, [케미 근적외선] 1.74 등)
  optionType      String    // 옵션타입 (안경렌즈 RX, 안경렌즈 여벌, 콘택트렌즈)
  productType     String    // 상품구분
  bundleName      String?   // 묶음상품명 (착색, 근적외선IR 등)
  erpCode         String?   // ERP 상품코드
  
  // 안경렌즈 관련
  refractiveIndex String?   // 굴절률 (1.56, 1.60, 1.67, 1.74)
  optionName      String?   // 옵션 (1.56 착색, 고, 고비, 중 등)
  
  // 처방 옵션
  hasSph          Boolean   @default(false) // SPH 사용 여부
  hasCyl          Boolean   @default(false) // CYL 사용 여부
  hasAxis         Boolean   @default(false) // AXIS 사용 여부
  hasBc           Boolean   @default(false) // BC 사용 여부
  hasDia          Boolean   @default(false) // DIA 사용 여부
  
  // 가격
  purchasePrice   Int       @default(0)     // 매입단가 (VAT포함)
  sellingPrice    Int       @default(0)     // 판매단가 (VAT포함)
  
  isActive        Boolean   @default(true)  // 상태
  displayOrder    Int       @default(0)     // 순서
  imageUrl        String?   // 이미지 URL
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  options         ProductOption[]
  orderItems      OrderItem[]

  @@index([brandId])
  @@index([optionType])
}

// 상품 옵션 (재고 관리용)
model ProductOption {
  id              Int       @id @default(autoincrement())
  productId       Int
  product         Product   @relation(fields: [productId], references: [id])
  
  sph             String?   // SPH 값
  cyl             String?   // CYL 값
  axis            String?   // AXIS 값
  optionName      String?   // 옵션이름
  memo            String?   // 메모
  barcode         String?   // 바코드
  stock           Int       @default(0) // 재고
  isActive        Boolean   @default(true) // 상태
  location        String?   // 재고 위치
  priceAdjustment Int       @default(0) // 가격 조정 (+ 또는 -)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([productId])
  @@index([barcode])
}

// 가맹점(거래처) 테이블
model Store {
  id            Int       @id @default(autoincrement())
  name          String    // 가맹점명
  code          String    @unique // 가맹점 코드
  phone         String?   // 전화번호
  address       String?   // 주소
  ownerName     String?   // 대표자명
  isActive      Boolean   @default(true)
  
  // 배송 정보
  deliveryContact   String?   // 배송 담당자
  deliveryPhone     String?   // 배송 연락처
  deliveryAddress   String?   // 배송 주소
  deliveryZipcode   String?   // 우편번호
  deliveryMemo      String?   // 배송 메모
  
  // 레티나 연동 정보
  retinaCode        String?   // 레티나 가맹점 코드
  retinaJoined      Boolean   @default(false) // 레티나 가입 여부
  retinaJoinedAt    DateTime? // 레티나 가입일
  
  // 유통사 정보
  distributorCode   String?   // 유통사 코드
  distributorStatus String?   // 승인상태 (pending, approved, rejected)
  
  // ===== 미수금 관리 (OlwsPro) =====
  outstandingAmount Int       @default(0)  // 미수금 잔액
  creditLimit       Int       @default(0)  // 신용한도
  paymentTermDays   Int       @default(30) // 결제 기한 (일)
  lastPaymentAt     DateTime?              // 최근 입금일
  
  // 담당/분류 정보
  salesRepName      String?   // 담당 영업사원명
  areaCode          String?   // 지역 코드 (강남, 동부, 서부, 케미 등)
  storeType         String?   // 거래처 유형 (도매, 소매)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  transactions  Transaction[]
}

// 주문 테이블
model Order {
  id            Int       @id @default(autoincrement())
  orderNo       String    @unique // 주문번호
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id])
  
  orderType     String    @default("stock") // stock(여벌), rx(맞춤제작)
  status        String    @default("pending") // pending, confirmed, shipped, delivered, cancelled
  totalAmount   Int       @default(0) // 총 금액
  memo          String?   // 메모
  
  orderedAt     DateTime  @default(now()) // 주문일시
  confirmedAt   DateTime? // 확인일시
  shippedAt     DateTime? // 출고일시
  deliveredAt   DateTime? // 배송완료일시
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         OrderItem[]
  shippingSlips ShippingSlip[]

  @@index([storeId])
  @@index([status])
  @@index([orderType])
  @@index([orderedAt])
}

// 주문 상세 테이블
model OrderItem {
  id            Int       @id @default(autoincrement())
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id])
  productId     Int
  product       Product   @relation(fields: [productId], references: [id])
  
  quantity      Int       @default(1) // 수량
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  // 처방 정보 (콘택트/안경렌즈용)
  sph           String?
  cyl           String?
  axis          String?
  bc            String?
  dia           String?
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([orderId])
  @@index([productId])
}

// ===== 입출금 내역 테이블 (OlwsPro) =====
model Transaction {
  id            Int       @id @default(autoincrement())
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id])
  
  type          String    // sale(매출), deposit(입금), return(반품), adjustment(조정)
  amount        Int       // 금액
  balanceAfter  Int       // 거래 후 잔액
  
  // 관련 주문 (매출/반품인 경우)
  orderId       Int?
  orderNo       String?
  
  // 입금 정보
  paymentMethod String?   // cash(현금), card(카드), transfer(계좌이체), check(어음)
  bankName      String?   // 은행명
  depositor     String?   // 입금자명
  
  memo          String?
  processedBy   String?   // 처리자
  processedAt   DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  
  @@index([storeId])
  @@index([type])
  @@index([processedAt])
}

// ===== 작업 로그 테이블 (OlwsPro) =====
model WorkLog {
  id            Int       @id @default(autoincrement())
  
  workType      String    // order_create, order_ship, stock_in, stock_out, payment, print
  targetType    String    // order, product, store
  targetId      Int?      // 대상 ID
  targetNo      String?   // 주문번호 등
  
  description   String    // 작업 설명
  details       String?   // 상세 내용 (JSON)
  
  userName      String?   // 작업자명
  pcName        String?   // PC명 (CHEMI-00 등)
  
  createdAt     DateTime  @default(now())
  
  @@index([workType])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ===== 출고 지시서 테이블 (OlwsPro) =====
model ShippingSlip {
  id            Int       @id @default(autoincrement())
  slipNo        String    @unique  // 출고지시서 번호
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id])
  
  status        String    @default("pending") // pending, picking, packed, shipped
  
  // 출고 정보
  pickedBy      String?   // 피킹 담당자
  pickedAt      DateTime?
  packedBy      String?   // 포장 담당자
  packedAt      DateTime?
  shippedBy     String?   // 출고 담당자
  shippedAt     DateTime?
  
  // 배송 정보
  courier       String?   // 택배사
  trackingNo    String?   // 운송장번호
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         ShippingSlipItem[]
  
  @@index([orderId])
  @@index([status])
}

// ===== 출고 지시서 상세 (OlwsPro) =====
model ShippingSlipItem {
  id            Int       @id @default(autoincrement())
  slipId        Int
  slip          ShippingSlip @relation(fields: [slipId], references: [id])
  
  orderItemId   Int       // 주문 상세 ID
  productId     Int
  productName   String    // 상품명 스냅샷
  optionName    String?   // 옵션명
  
  // 도수 정보
  sph           String?
  cyl           String?
  axis          String?
  
  quantity      Int       // 출고 수량
  location      String?   // 재고 위치
  barcode       String?   // 바코드
  
  isPicked      Boolean   @default(false)  // 피킹 완료
  pickedAt      DateTime?
  
  @@index([slipId])
}

// ===== 도수 범위 설정 테이블 (OlwsPro) =====
model DiopterRange {
  id            Int       @id @default(autoincrement())
  name          String    @unique // S200, S400, S600, S800, ADD 등
  description   String?   // 설명
  
  // SPH 범위
  sphMin        Float     // 최소 SPH (예: 0.00)
  sphMax        Float     // 최대 SPH (예: -2.00)
  sphStep       Float     @default(0.25) // SPH 단계
  
  // CYL 범위
  cylMin        Float     @default(0)
  cylMax        Float     @default(0)
  cylStep       Float     @default(0.25)
  
  // ADD 범위 (누진용)
  addMin        Float?
  addMax        Float?
  addStep       Float?
  
  displayOrder  Int       @default(0)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ===== 거래명세서 테이블 (OlwsPro) =====
model DeliveryStatement {
  id            Int       @id @default(autoincrement())
  statementNo   String    @unique  // 명세서 번호
  storeId       Int
  orderId       Int?      // 관련 주문
  
  // 금액
  totalAmount   Int       // 합계 금액
  
  issueDate     DateTime  // 발행일
  printCount    Int       @default(0) // 출력 횟수
  lastPrintedAt DateTime?
  lastPrintedBy String?
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  
  @@index([storeId])
  @@index([orderId])
  @@index([issueDate])
}

// ===== 세금계산서 테이블 (OlwsPro) =====
model TaxInvoice {
  id            Int       @id @default(autoincrement())
  invoiceNo     String    @unique  // 세금계산서 번호
  storeId       Int
  
  // 공급자 정보
  supplierBizNo     String   // 사업자등록번호
  supplierName      String   // 상호
  supplierCeoName   String   // 대표자명
  supplierAddress   String   // 주소
  supplierBizType   String?  // 업태
  supplierBizItem   String?  // 종목
  
  // 공급받는자 정보
  buyerBizNo        String   // 사업자등록번호
  buyerName         String   // 상호
  buyerCeoName      String?  // 대표자명
  buyerAddress      String?  // 주소
  
  // 금액
  supplyAmount      Int      // 공급가액
  taxAmount         Int      // 세액
  totalAmount       Int      // 합계
  
  // 날짜
  issueDate         DateTime // 발행일
  supplyDate        DateTime // 공급일
  
  // 상태
  status            String   @default("issued") // issued, sent, cancelled
  sentAt            DateTime?
  cancelledAt       DateTime?
  cancelReason      String?
  
  memo              String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  items             TaxInvoiceItem[]
  
  @@index([storeId])
  @@index([issueDate])
  @@index([status])
}

// ===== 세금계산서 상세 (OlwsPro) =====
model TaxInvoiceItem {
  id            Int       @id @default(autoincrement())
  invoiceId     Int
  invoice       TaxInvoice @relation(fields: [invoiceId], references: [id])
  
  itemDate      DateTime  // 일자
  itemName      String    // 품목
  spec          String?   // 규격
  quantity      Int       // 수량
  unitPrice     Int       // 단가
  supplyAmount  Int       // 공급가액
  taxAmount     Int       // 세액
  memo          String?   // 비고
  
  @@index([invoiceId])
}

// 매입처 (공급사) 테이블
model Supplier {
  id            Int       @id @default(autoincrement())
  name          String    // 매입처명
  code          String    @unique // 매입처 코드
  contactName   String?   // 담당자명
  phone         String?   // 연락처
  email         String?   // 이메일
  address       String?   // 주소
  bankInfo      String?   // 계좌정보
  memo          String?   // 메모
  isActive      Boolean   @default(true)
  
  // 미납금 관리
  outstandingAmount Int   @default(0) // 미납금액
  creditLimit       Int   @default(0) // 신용한도
  paymentTermDays   Int   @default(30) // 결제 기한 (일)
  lastPaymentAt     DateTime? // 최근 결제일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  purchases     Purchase[]
}

// 매입 테이블
model Purchase {
  id            Int       @id @default(autoincrement())
  purchaseNo    String    @unique // 매입번호
  supplierId    Int
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  
  status        String    @default("pending") // pending(입고대기), completed(입고완료), cancelled(취소)
  totalAmount   Int       @default(0) // 총 매입금액
  memo          String?   // 메모
  
  purchasedAt   DateTime  @default(now()) // 매입일
  receivedAt    DateTime? // 입고일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         PurchaseItem[]

  @@index([supplierId])
  @@index([status])
  @@index([purchasedAt])
}

// 매입 상세 테이블
model PurchaseItem {
  id            Int       @id @default(autoincrement())
  purchaseId    Int
  purchase      Purchase  @relation(fields: [purchaseId], references: [id])
  productId     Int
  
  quantity      Int       @default(1) // 수량
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([purchaseId])
}

// 설정 테이블 (key-value 형태)
model Setting {
  id            Int       @id @default(autoincrement())
  key           String    @unique // 설정키
  value         String    // 설정값 (JSON string)
  description   String?   // 설명
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 가맹점 그룹 테이블
model StoreGroup {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 그룹명
  description   String?   // 설명
  discountRate  Float     @default(0) // 기본 할인율 (%)
  storeType     String    @default("normal") // 가맹점 타입 (normal, vip, wholesale 등)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  stores        StoreGroupMember[]
  brandDiscounts BrandDiscount[]
}

// 가맹점-그룹 연결 테이블
model StoreGroupMember {
  id            Int       @id @default(autoincrement())
  storeId       Int
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  
  createdAt     DateTime  @default(now())
  
  @@unique([storeId, groupId])
  @@index([storeId])
  @@index([groupId])
}

// 브랜드별 할인율 테이블
model BrandDiscount {
  id            Int       @id @default(autoincrement())
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  brandId       Int
  discountRate  Float     // 할인율 (%)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([groupId, brandId])
  @@index([groupId])
  @@index([brandId])
}

// 공지사항 테이블
model Notice {
  id            Int       @id @default(autoincrement())
  title         String    // 제목
  content       String    // 내용
  type          String    @default("notice") // notice, event, urgent
  isImportant   Boolean   @default(false) // 중요 공지
  isPinned      Boolean   @default(false) // 상단 고정
  viewCount     Int       @default(0)     // 조회수
  startDate     DateTime? // 게시 시작일
  endDate       DateTime? // 게시 종료일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 출력 이력 테이블
model PrintHistory {
  id            Int       @id @default(autoincrement())
  orderId       Int?      // 관련 주문
  orderNo       String    // 주문번호
  storeName     String    // 가맹점명
  printType     String    // 출력유형 (거래명세서, 출고명세서, 납품확인서)
  printedBy     String    // 출력자
  pageCount     Int       @default(1) // 페이지 수
  
  printedAt     DateTime  @default(now())
  
  @@index([orderId])
  @@index([printedAt])
}

// 묶음상품 테이블
model BundleProduct {
  id            Int       @id @default(autoincrement())
  name          String    // 묶음상품명
  description   String?   // 설명
  discountRate  Float     @default(0) // 묶음 할인율 (%)
  discountAmount Int      @default(0) // 묶음 할인액
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         BundleItem[]
}

// 묶음상품 구성 테이블
model BundleItem {
  id            Int       @id @default(autoincrement())
  bundleId      Int
  bundle        BundleProduct @relation(fields: [bundleId], references: [id])
  productId     Int
  quantity      Int       @default(1)
  
  @@index([bundleId])
  @@index([productId])
}

// 상품 단축코드 테이블
model ProductShortcut {
  id            Int       @id @default(autoincrement())
  shortcode     String    @unique // 단축코드
  productId     Int       // 연결 상품
  description   String?   // 설명
  useCount      Int       @default(0) // 사용 횟수
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([productId])
}

// 배송 구역 테이블
model ShippingZone {
  id            Int       @id @default(autoincrement())
  name          String    // 구역명
  regions       String    // 지역 목록 (JSON array)
  baseFee       Int       @default(0) // 기본 배송비
  freeThreshold Int       @default(0) // 무료배송 기준금액
  extraFee      Int       @default(0) // 추가 배송비 (도서산간)
  deliveryDays  Int       @default(1) // 예상 배송일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 구분(카테고리) 설정 테이블
model Category {
  id            Int       @id @default(autoincrement())
  type          String    // 구분 타입 (optionType, productType, orderStatus 등)
  code          String    // 코드
  name          String    // 표시명
  description   String?   // 설명
  displayOrder  Int       @default(0) // 표시 순서
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([type, code])
  @@index([type])
}

// ===== 사용자 인증 테이블 =====
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  username      String    @unique
  password      String    // bcrypt 해시
  name          String    // 실명
  role          String    @default("user") // admin, manager, user
  
  // 권한 설정
  permissions   String?   // JSON array of permissions
  
  // 연결된 가맹점 (가맹점 계정인 경우)
  storeId       Int?
  
  // 상태
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([role])
  @@index([storeId])
}

// 세션 테이블 (NextAuth용)
model Session {
  id            Int       @id @default(autoincrement())
  sessionToken  String    @unique
  userId        Int
  expires       DateTime
  
  createdAt     DateTime  @default(now())
}

// 로그인 이력 테이블
model LoginHistory {
  id            Int       @id @default(autoincrement())
  userId        Int
  username      String
  ipAddress     String?
  userAgent     String?
  success       Boolean   @default(true)
  failReason    String?
  
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([createdAt])
}
