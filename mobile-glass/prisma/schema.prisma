// MobileGlass - 모바일글라스 데이터베이스 스키마
// 레티나 주문시스템 데이터 기반

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 브랜드 테이블
model Brand {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 브랜드명 (케미, 하이텍, 진명 등)
  stockManage   String?   // 출고 관리 (바코드, 미사용)
  canExchange   Boolean   @default(false) // 교환 가능 여부
  canReturn     Boolean   @default(false) // 반품 가능 여부
  isActive      Boolean   @default(true)  // 상태 (사용/미사용)
  displayOrder  Int       @default(0)     // 노출순서
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  products      Product[]
}

// 상품 테이블
model Product {
  id              Int       @id @default(autoincrement())
  brandId         Int
  brand           Brand     @relation(fields: [brandId], references: [id])
  
  name            String    // 상품명 (1.56 착색, [케미 근적외선] 1.74 등)
  optionType      String    // 옵션타입 (안경렌즈 RX, 안경렌즈 여벌, 콘택트렌즈)
  productType     String    // 상품구분
  bundleName      String?   // 묶음상품명 (착색, 근적외선IR 등)
  erpCode         String?   // ERP 상품코드
  
  // 안경렌즈 관련
  refractiveIndex String?   // 굴절률 (1.56, 1.60, 1.67, 1.74)
  optionName      String?   // 옵션 (1.56 착색, 고, 고비, 중 등)
  
  // 처방 옵션
  hasSph          Boolean   @default(false) // SPH 사용 여부
  hasCyl          Boolean   @default(false) // CYL 사용 여부
  hasAxis         Boolean   @default(false) // AXIS 사용 여부
  hasBc           Boolean   @default(false) // BC 사용 여부
  hasDia          Boolean   @default(false) // DIA 사용 여부
  
  // 가격
  purchasePrice   Int       @default(0)     // 매입단가 (VAT포함)
  sellingPrice    Int       @default(0)     // 판매단가 (VAT포함)
  
  isActive        Boolean   @default(true)  // 상태
  displayOrder    Int       @default(0)     // 순서
  imageUrl        String?   // 이미지 URL
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  options         ProductOption[]
  orderItems      OrderItem[]

  @@index([brandId])
  @@index([optionType])
}

// 상품 옵션 (재고 관리용)
model ProductOption {
  id              Int       @id @default(autoincrement())
  productId       Int
  product         Product   @relation(fields: [productId], references: [id])
  
  sph             String?   // SPH 값
  cyl             String?   // CYL 값
  axis            String?   // AXIS 값
  optionName      String?   // 옵션이름
  memo            String?   // 메모
  barcode         String?   // 바코드
  stock           Int       @default(0) // 재고
  isActive        Boolean   @default(true) // 상태
  location        String?   // 재고 위치
  priceAdjustment Int       @default(0) // 가격 조정 (+ 또는 -)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([productId])
  @@index([barcode])
}

// 가맹점 테이블
model Store {
  id            Int       @id @default(autoincrement())
  name          String    // 가맹점명
  code          String    @unique // 가맹점 코드
  phone         String?   // 전화번호
  address       String?   // 주소
  ownerName     String?   // 대표자명
  isActive      Boolean   @default(true)
  
  // 배송 정보
  deliveryContact   String?   // 배송 담당자
  deliveryPhone     String?   // 배송 연락처
  deliveryAddress   String?   // 배송 주소
  deliveryZipcode   String?   // 우편번호
  deliveryMemo      String?   // 배송 메모
  
  // 레티나 연동 정보
  retinaCode        String?   // 레티나 가맹점 코드
  retinaJoined      Boolean   @default(false) // 레티나 가입 여부
  retinaJoinedAt    DateTime? // 레티나 가입일
  
  // 유통사 정보
  distributorCode   String?   // 유통사 코드
  distributorStatus String?   // 승인상태 (pending, approved, rejected)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
}

// 주문 테이블
model Order {
  id            Int       @id @default(autoincrement())
  orderNo       String    @unique // 주문번호
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id])
  
  orderType     String    @default("stock") // stock(여벌), rx(맞춤제작)
  status        String    @default("pending") // pending, confirmed, shipped, delivered, cancelled
  totalAmount   Int       @default(0) // 총 금액
  memo          String?   // 메모
  
  orderedAt     DateTime  @default(now()) // 주문일시
  confirmedAt   DateTime? // 확인일시
  shippedAt     DateTime? // 출고일시
  deliveredAt   DateTime? // 배송완료일시
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         OrderItem[]

  @@index([storeId])
  @@index([status])
  @@index([orderType])
  @@index([orderedAt])
}

// 주문 상세 테이블
model OrderItem {
  id            Int       @id @default(autoincrement())
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id])
  productId     Int
  product       Product   @relation(fields: [productId], references: [id])
  
  quantity      Int       @default(1) // 수량
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  // 처방 정보 (콘택트/안경렌즈용)
  sph           String?
  cyl           String?
  axis          String?
  bc            String?
  dia           String?
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([orderId])
  @@index([productId])
}

// 매입처 (공급사) 테이블
model Supplier {
  id            Int       @id @default(autoincrement())
  name          String    // 매입처명
  code          String    @unique // 매입처 코드
  contactName   String?   // 담당자명
  phone         String?   // 연락처
  email         String?   // 이메일
  address       String?   // 주소
  bankInfo      String?   // 계좌정보
  memo          String?   // 메모
  isActive      Boolean   @default(true)
  
  // 미납금 관리
  outstandingAmount Int   @default(0) // 미납금액
  creditLimit       Int   @default(0) // 신용한도
  paymentTermDays   Int   @default(30) // 결제 기한 (일)
  lastPaymentAt     DateTime? // 최근 결제일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  purchases     Purchase[]
}

// 매입 테이블
model Purchase {
  id            Int       @id @default(autoincrement())
  purchaseNo    String    @unique // 매입번호
  supplierId    Int
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  
  status        String    @default("pending") // pending(입고대기), completed(입고완료), cancelled(취소)
  totalAmount   Int       @default(0) // 총 매입금액
  memo          String?   // 메모
  
  purchasedAt   DateTime  @default(now()) // 매입일
  receivedAt    DateTime? // 입고일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         PurchaseItem[]

  @@index([supplierId])
  @@index([status])
  @@index([purchasedAt])
}

// 매입 상세 테이블
model PurchaseItem {
  id            Int       @id @default(autoincrement())
  purchaseId    Int
  purchase      Purchase  @relation(fields: [purchaseId], references: [id])
  productId     Int
  
  quantity      Int       @default(1) // 수량
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([purchaseId])
}

// 설정 테이블 (key-value 형태)
model Setting {
  id            Int       @id @default(autoincrement())
  key           String    @unique // 설정키
  value         String    // 설정값 (JSON string)
  description   String?   // 설명
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 가맹점 그룹 테이블
model StoreGroup {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 그룹명
  description   String?   // 설명
  discountRate  Float     @default(0) // 기본 할인율 (%)
  storeType     String    @default("normal") // 가맹점 타입 (normal, vip, wholesale 등)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  stores        StoreGroupMember[]
  brandDiscounts BrandDiscount[]
}

// 가맹점-그룹 연결 테이블
model StoreGroupMember {
  id            Int       @id @default(autoincrement())
  storeId       Int
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  
  createdAt     DateTime  @default(now())
  
  @@unique([storeId, groupId])
  @@index([storeId])
  @@index([groupId])
}

// 브랜드별 할인율 테이블
model BrandDiscount {
  id            Int       @id @default(autoincrement())
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  brandId       Int
  discountRate  Float     // 할인율 (%)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([groupId, brandId])
  @@index([groupId])
  @@index([brandId])
}

// 공지사항 테이블
model Notice {
  id            Int       @id @default(autoincrement())
  title         String    // 제목
  content       String    // 내용
  type          String    @default("notice") // notice, event, urgent
  isImportant   Boolean   @default(false) // 중요 공지
  isPinned      Boolean   @default(false) // 상단 고정
  viewCount     Int       @default(0)     // 조회수
  startDate     DateTime? // 게시 시작일
  endDate       DateTime? // 게시 종료일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 출력 이력 테이블
model PrintHistory {
  id            Int       @id @default(autoincrement())
  orderId       Int?      // 관련 주문
  orderNo       String    // 주문번호
  storeName     String    // 가맹점명
  printType     String    // 출력유형 (거래명세서, 출고명세서, 납품확인서)
  printedBy     String    // 출력자
  pageCount     Int       @default(1) // 페이지 수
  
  printedAt     DateTime  @default(now())
  
  @@index([orderId])
  @@index([printedAt])
}

// 묶음상품 테이블
model BundleProduct {
  id            Int       @id @default(autoincrement())
  name          String    // 묶음상품명
  description   String?   // 설명
  discountRate  Float     @default(0) // 묶음 할인율 (%)
  discountAmount Int      @default(0) // 묶음 할인액
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         BundleItem[]
}

// 묶음상품 구성 테이블
model BundleItem {
  id            Int       @id @default(autoincrement())
  bundleId      Int
  bundle        BundleProduct @relation(fields: [bundleId], references: [id])
  productId     Int
  quantity      Int       @default(1)
  
  @@index([bundleId])
  @@index([productId])
}

// 상품 단축코드 테이블
model ProductShortcut {
  id            Int       @id @default(autoincrement())
  shortcode     String    @unique // 단축코드
  productId     Int       // 연결 상품
  description   String?   // 설명
  useCount      Int       @default(0) // 사용 횟수
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([productId])
}

// 배송 구역 테이블
model ShippingZone {
  id            Int       @id @default(autoincrement())
  name          String    // 구역명
  regions       String    // 지역 목록 (JSON array)
  baseFee       Int       @default(0) // 기본 배송비
  freeThreshold Int       @default(0) // 무료배송 기준금액
  extraFee      Int       @default(0) // 추가 배송비 (도서산간)
  deliveryDays  Int       @default(1) // 예상 배송일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 구분(카테고리) 설정 테이블
model Category {
  id            Int       @id @default(autoincrement())
  type          String    // 구분 타입 (optionType, productType, orderStatus 등)
  code          String    // 코드
  name          String    // 표시명
  description   String?   // 설명
  displayOrder  Int       @default(0) // 표시 순서
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([type, code])
  @@index([type])
}
