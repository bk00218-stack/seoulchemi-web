// MobileGlass - 렌즈초이스 데이터베이스 스키마
// OlwsPro 기능 통합 버전

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== 대분류 (Main Category) =====
// 안경렌즈 여벌, 안경렌즈 RX, 콘택트렌즈, 착색 등
model MainCategory {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 대분류명
  code          String    @unique // 코드 (SPARE, RX, CONTACT, TINT 등)
  description   String?   // 설명
  displayOrder  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  brands        Brand[]
}

// ===== 브랜드 테이블 =====
model Brand {
  id            Int       @id @default(autoincrement())
  categoryId    Int?      // 대분류 연결
  category      MainCategory? @relation(fields: [categoryId], references: [id])
  name          String    // 브랜드명 (케미, 하이텍, 진명 등)
  stockManage   String?   // 출고 관리 (바코드, 미사용)
  canExchange   Boolean   @default(false) // 교환 가능 여부
  canReturn     Boolean   @default(false) // 반품 가능 여부
  isActive      Boolean   @default(true)  // 상태 (사용/미사용)
  displayOrder  Int       @default(0)     // 노출순서
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  productLines  ProductLine[]
  products      Product[]
  storeDiscounts StoreBrandDiscount[]

  @@unique([categoryId, name]) // 같은 대분류 내 브랜드명 중복 불가
  @@index([categoryId])
}

// ===== 품목 (Product Line) =====
// 블루라이트차단, 누진다초점, 변색렌즈 등
model ProductLine {
  id            Int       @id @default(autoincrement())
  brandId       Int
  brand         Brand     @relation(fields: [brandId], references: [id])
  name          String    // 품목명
  code          String?   // 품목 코드
  description   String?   // 설명
  displayOrder  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  products      Product[]

  @@unique([brandId, name]) // 같은 브랜드 내 품목명 중복 불가
  @@index([brandId])
}

// 상품 테이블
model Product {
  id              Int       @id @default(autoincrement())
  brandId         Int
  brand           Brand     @relation(fields: [brandId], references: [id])
  productLineId   Int?      // 품목 연결
  productLine     ProductLine? @relation(fields: [productLineId], references: [id])
  
  name            String    // 상품명 (1.56 착색, [케미 근적외선] 1.74 등)
  optionType      String    // 옵션타입 (안경렌즈 RX, 안경렌즈 여벌, 콘택트렌즈) - 대분류 참조용 (레거시)
  productType     String    // 상품구분
  bundleName      String?   // 묶음상품명 (착색, 근적외선IR 등)
  erpCode         String?   // ERP 상품코드
  
  // 안경렌즈 관련
  refractiveIndex String?   // 굴절률 (1.56, 1.60, 1.67, 1.74)
  optionName      String?   // 옵션 (1.56 착색, 고, 고비, 중 등)
  
  // 처방 옵션
  hasSph          Boolean   @default(false) // SPH 사용 여부
  hasCyl          Boolean   @default(false) // CYL 사용 여부
  hasAxis         Boolean   @default(false) // AXIS 사용 여부
  hasBc           Boolean   @default(false) // BC 사용 여부
  hasDia          Boolean   @default(false) // DIA 사용 여부
  
  // 가격
  purchasePrice   Int       @default(0)     // 매입단가 (VAT포함)
  sellingPrice    Int       @default(0)     // 판매단가 (VAT포함)
  
  isActive        Boolean   @default(true)  // 상태
  displayOrder    Int       @default(0)     // 순서
  imageUrl        String?   // 이미지 URL
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  options         ProductOption[]
  orderItems      OrderItem[]
  storeDiscounts  StoreProductDiscount[]
  storePrices     StoreProductPrice[]

  @@index([brandId])
  @@index([productLineId])
  @@index([optionType])
}

// 상품 옵션 (재고 관리용)
model ProductOption {
  id              Int       @id @default(autoincrement())
  productId       Int
  product         Product   @relation(fields: [productId], references: [id])
  
  sph             String?   // SPH 값
  cyl             String?   // CYL 값
  axis            String?   // AXIS 값
  optionName      String?   // 옵션이름
  memo            String?   // 메모
  barcode         String?   // 바코드
  stock           Float     @default(0) // 재고 (안경렌즈: 0.5=한쪽, 1=양쪽)
  isActive        Boolean   @default(true) // 상태
  location        String?   // 재고 위치
  priceAdjustment Int       @default(0) // 가격 조정 (+ 또는 -)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([productId])
  @@index([barcode])
}

// 배송담당자 테이블
model DeliveryStaff {
  id          Int      @id @default(autoincrement())
  name        String   // 배송담당자명
  phone       String?  // 연락처
  areaCode    String?  // 담당지역
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stores      Store[]
}

// 영업담당자 테이블
model SalesStaff {
  id          Int      @id @default(autoincrement())
  name        String   // 영업담당자명
  phone       String?  // 연락처
  areaCode    String?  // 담당지역
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stores      Store[]  @relation("SalesStaffStores")
}

// 가맹점(거래처) 테이블
model Store {
  id            Int       @id @default(autoincrement())
  name          String    // 가맹점명
  code          String    @unique // 가맹점 코드
  phone         String?   // 전화번호
  address       String?   // 주소
  ownerName     String?   // 대표자명
  isActive      Boolean   @default(true)
  
  // ===== 신규 필드 (거래처 등록 확장) =====
  businessType      String?   // 업태
  businessCategory  String?   // 업종
  businessRegNo     String?   // 사업자등록번호
  groupId           Int?      // StoreGroup FK
  group             StoreGroup? @relation(fields: [groupId], references: [id])
  email             String?   // 메일주소
  memo              String?   // 기타사항
  status            String    @default("active") // 거래상태: active, suspended, caution
  deliveryStaffId   Int?      // DeliveryStaff FK
  deliveryStaff     DeliveryStaff? @relation(fields: [deliveryStaffId], references: [id])
  salesStaffId      Int?      // SalesStaff FK
  salesStaff        SalesStaff? @relation("SalesStaffStores", fields: [salesStaffId], references: [id])
  
  // 배송 정보
  deliveryContact   String?   // 배송 담당자
  deliveryPhone     String?   // 배송 연락처
  deliveryAddress   String?   // 배송 주소
  deliveryZipcode   String?   // 우편번호
  deliveryMemo      String?   // 배송 메모
  
  // 레티나 연동 정보
  retinaCode        String?   // 레티나 가맹점 코드
  retinaJoined      Boolean   @default(false) // 레티나 가입 여부
  retinaJoinedAt    DateTime? // 레티나 가입일
  
  // 유통사 정보
  distributorCode   String?   // 유통사 코드
  distributorStatus String?   // 승인상태 (pending, approved, rejected)
  
  // ===== 미수금 관리 (OlwsPro) =====
  outstandingAmount Int       @default(0)  // 미수금 잔액
  creditLimit       Int       @default(0)  // 신용한도
  paymentTermDays   Int       @default(30) // 결제 기한 (일)
  billingDay        Int?                   // 청구일 (매월 N일, 1-31)
  lastPaymentAt     DateTime?              // 최근 입금일
  
  // ===== 할인 설정 =====
  discountRate      Float     @default(0)  // 기본 할인율 (%)
  
  // 담당/분류 정보
  salesRepName      String?   // 담당 영업사원명
  areaCode          String?   // 지역 코드 (강남, 동부, 서부, 케미 등)
  storeType         String?   // 거래처 유형 (도매, 소매)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  transactions  Transaction[]
  brandDiscounts    StoreBrandDiscount[]
  productDiscounts  StoreProductDiscount[]
  productPrices     StoreProductPrice[]
  
  @@index([groupId])
  @@index([deliveryStaffId])
  @@index([salesStaffId])
  @@index([name])
  @@index([isActive])
  @@index([salesRepName])
  @@index([deliveryContact])
  @@index([isActive, name])
}

// 주문 테이블
model Order {
  id            Int       @id @default(autoincrement())
  orderNo       String    @unique // 주문번호
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id])
  
  orderType     String    @default("stock") // stock(여벌), rx(맞춤제작)
  status        String    @default("pending") // pending, confirmed, shipped, delivered, cancelled
  totalAmount   Int       @default(0) // 총 금액
  memo          String?   // 메모
  
  orderedAt     DateTime  @default(now()) // 주문일시
  confirmedAt   DateTime? // 확인일시
  shippedAt     DateTime? // 출고일시
  deliveredAt   DateTime? // 배송완료일시
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         OrderItem[]
  shippingSlips ShippingSlip[]

  @@index([storeId])
  @@index([status])
  @@index([orderType])
  @@index([orderedAt])
}

// 주문 상세 테이블
model OrderItem {
  id            Int       @id @default(autoincrement())
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id])
  productId     Int
  product       Product   @relation(fields: [productId], references: [id])
  
  quantity      Float     @default(1) // 수량 (안경렌즈: 0.5=한쪽, 1=양쪽)
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  // 처방 정보 (콘택트/안경렌즈용)
  sph           String?
  cyl           String?
  axis          String?
  bc            String?
  dia           String?
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([orderId])
  @@index([productId])
}

// ===== 입출금 내역 테이블 (OlwsPro) =====
model Transaction {
  id            Int       @id @default(autoincrement())
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id])
  
  type          String    // sale(매출), deposit(입금), return(반품), adjustment(조정)
  amount        Int       // 금액
  balanceAfter  Int       // 거래 후 잔액
  
  // 관련 주문 (매출/반품인 경우)
  orderId       Int?
  orderNo       String?
  
  // 입금 정보
  paymentMethod String?   // cash(현금), card(카드), transfer(계좌이체), check(어음)
  bankName      String?   // 은행명
  depositor     String?   // 입금자명
  
  memo          String?
  processedBy   String?   // 처리자
  processedAt   DateTime  @default(now())
  
  createdAt     DateTime  @default(now())
  
  @@index([storeId])
  @@index([type])
  @@index([processedAt])
}

// ===== 작업 로그 테이블 (OlwsPro) =====
model WorkLog {
  id            Int       @id @default(autoincrement())
  
  workType      String    // order_create, order_ship, stock_in, stock_out, payment, print
  targetType    String    // order, product, store
  targetId      Int?      // 대상 ID
  targetNo      String?   // 주문번호 등
  
  description   String    // 작업 설명
  details       String?   // 상세 내용 (JSON)
  
  userName      String?   // 작업자명
  pcName        String?   // PC명 (CHEMI-00 등)
  
  createdAt     DateTime  @default(now())
  
  @@index([workType])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ===== 출고 지시서 테이블 (OlwsPro) =====
model ShippingSlip {
  id            Int       @id @default(autoincrement())
  slipNo        String    @unique  // 출고지시서 번호
  orderId       Int
  order         Order     @relation(fields: [orderId], references: [id])
  
  status        String    @default("pending") // pending, picking, packed, shipped
  
  // 출고 정보
  pickedBy      String?   // 피킹 담당자
  pickedAt      DateTime?
  packedBy      String?   // 포장 담당자
  packedAt      DateTime?
  shippedBy     String?   // 출고 담당자
  shippedAt     DateTime?
  
  // 배송 정보
  courier       String?   // 택배사
  trackingNo    String?   // 운송장번호
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         ShippingSlipItem[]
  
  @@index([orderId])
  @@index([status])
}

// ===== 출고 지시서 상세 (OlwsPro) =====
model ShippingSlipItem {
  id            Int       @id @default(autoincrement())
  slipId        Int
  slip          ShippingSlip @relation(fields: [slipId], references: [id])
  
  orderItemId   Int       // 주문 상세 ID
  productId     Int
  productName   String    // 상품명 스냅샷
  optionName    String?   // 옵션명
  
  // 도수 정보
  sph           String?
  cyl           String?
  axis          String?
  
  quantity      Float     // 출고 수량 (안경렌즈: 0.5=한쪽)
  location      String?   // 재고 위치
  barcode       String?   // 바코드
  
  isPicked      Boolean   @default(false)  // 피킹 완료
  pickedAt      DateTime?
  
  @@index([slipId])
}

// ===== 도수 범위 설정 테이블 (OlwsPro) =====
model DiopterRange {
  id            Int       @id @default(autoincrement())
  name          String    @unique // S200, S400, S600, S800, ADD 등
  description   String?   // 설명
  
  // SPH 범위
  sphMin        Float     // 최소 SPH (예: 0.00)
  sphMax        Float     // 최대 SPH (예: -2.00)
  sphStep       Float     @default(0.25) // SPH 단계
  
  // CYL 범위
  cylMin        Float     @default(0)
  cylMax        Float     @default(0)
  cylStep       Float     @default(0.25)
  
  // ADD 범위 (누진용)
  addMin        Float?
  addMax        Float?
  addStep       Float?
  
  displayOrder  Int       @default(0)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ===== 거래명세서 테이블 (OlwsPro) =====
model DeliveryStatement {
  id            Int       @id @default(autoincrement())
  statementNo   String    @unique  // 명세서 번호
  storeId       Int
  orderId       Int?      // 관련 주문
  
  // 금액
  totalAmount   Int       // 합계 금액
  
  issueDate     DateTime  // 발행일
  printCount    Int       @default(0) // 출력 횟수
  lastPrintedAt DateTime?
  lastPrintedBy String?
  
  memo          String?
  
  createdAt     DateTime  @default(now())
  
  @@index([storeId])
  @@index([orderId])
  @@index([issueDate])
}

// ===== 세금계산서 테이블 (OlwsPro) =====
model TaxInvoice {
  id            Int       @id @default(autoincrement())
  invoiceNo     String    @unique  // 세금계산서 번호
  storeId       Int
  
  // 공급자 정보
  supplierBizNo     String   // 사업자등록번호
  supplierName      String   // 상호
  supplierCeoName   String   // 대표자명
  supplierAddress   String   // 주소
  supplierBizType   String?  // 업태
  supplierBizItem   String?  // 종목
  
  // 공급받는자 정보
  buyerBizNo        String   // 사업자등록번호
  buyerName         String   // 상호
  buyerCeoName      String?  // 대표자명
  buyerAddress      String?  // 주소
  
  // 금액
  supplyAmount      Int      // 공급가액
  taxAmount         Int      // 세액
  totalAmount       Int      // 합계
  
  // 날짜
  issueDate         DateTime // 발행일
  supplyDate        DateTime // 공급일
  
  // 상태
  status            String   @default("issued") // issued, sent, cancelled
  sentAt            DateTime?
  cancelledAt       DateTime?
  cancelReason      String?
  
  memo              String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  items             TaxInvoiceItem[]
  
  @@index([storeId])
  @@index([issueDate])
  @@index([status])
}

// ===== 세금계산서 상세 (OlwsPro) =====
model TaxInvoiceItem {
  id            Int       @id @default(autoincrement())
  invoiceId     Int
  invoice       TaxInvoice @relation(fields: [invoiceId], references: [id])
  
  itemDate      DateTime  // 일자
  itemName      String    // 품목
  spec          String?   // 규격
  quantity      Float     // 수량 (안경렌즈: 0.5=한쪽)
  unitPrice     Int       // 단가
  supplyAmount  Int       // 공급가액
  taxAmount     Int       // 세액
  memo          String?   // 비고
  
  @@index([invoiceId])
}

// 매입처 (공급사) 테이블
model Supplier {
  id            Int       @id @default(autoincrement())
  name          String    // 매입처명
  code          String    @unique // 매입처 코드
  contactName   String?   // 담당자명
  phone         String?   // 연락처
  email         String?   // 이메일
  address       String?   // 주소
  bankInfo      String?   // 계좌정보
  memo          String?   // 메모
  isActive      Boolean   @default(true)
  
  // 미납금 관리
  outstandingAmount Int   @default(0) // 미납금액
  creditLimit       Int   @default(0) // 신용한도
  paymentTermDays   Int   @default(30) // 결제 기한 (일)
  lastPaymentAt     DateTime? // 최근 결제일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  purchases     Purchase[]
}

// 매입 테이블
model Purchase {
  id            Int       @id @default(autoincrement())
  purchaseNo    String    @unique // 매입번호
  supplierId    Int
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  
  status        String    @default("pending") // pending(입고대기), completed(입고완료), cancelled(취소)
  totalAmount   Int       @default(0) // 총 매입금액
  memo          String?   // 메모
  
  purchasedAt   DateTime  @default(now()) // 매입일
  receivedAt    DateTime? // 입고일
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         PurchaseItem[]

  @@index([supplierId])
  @@index([status])
  @@index([purchasedAt])
}

// 매입 상세 테이블
model PurchaseItem {
  id            Int       @id @default(autoincrement())
  purchaseId    Int
  purchase      Purchase  @relation(fields: [purchaseId], references: [id])
  productId     Int
  
  quantity      Float     @default(1) // 수량 (안경렌즈: 0.5=한쪽)
  unitPrice     Int       // 단가
  totalPrice    Int       // 소계
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([purchaseId])
}

// 설정 테이블 (key-value 형태)
model Setting {
  id            Int       @id @default(autoincrement())
  key           String    @unique // 설정키
  value         String    // 설정값 (JSON string)
  description   String?   // 설명
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 가맹점 그룹 테이블
model StoreGroup {
  id            Int       @id @default(autoincrement())
  name          String    @unique // 그룹명
  description   String?   // 설명
  discountRate  Float     @default(0) // 기본 할인율 (%)
  storeType     String    @default("normal") // 가맹점 타입 (normal, vip, wholesale 등)
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  members       StoreGroupMember[]
  brandDiscounts BrandDiscount[]
  stores        Store[]  // 직접 연결된 가맹점
}

// 가맹점-그룹 연결 테이블
model StoreGroupMember {
  id            Int       @id @default(autoincrement())
  storeId       Int
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  
  createdAt     DateTime  @default(now())
  
  @@unique([storeId, groupId])
  @@index([storeId])
  @@index([groupId])
}

// 브랜드별 할인율 테이블
model BrandDiscount {
  id            Int       @id @default(autoincrement())
  groupId       Int
  group         StoreGroup @relation(fields: [groupId], references: [id])
  brandId       Int
  discountRate  Float     // 할인율 (%)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([groupId, brandId])
  @@index([groupId])
  @@index([brandId])
}

// 공지사항 테이블
model Notice {
  id            Int       @id @default(autoincrement())
  title         String    // 제목
  content       String    // 내용
  type          String    @default("notice") // notice, event, urgent
  isImportant   Boolean   @default(false) // 중요 공지
  isPinned      Boolean   @default(false) // 상단 고정
  viewCount     Int       @default(0)     // 조회수
  startDate     DateTime? // 게시 시작일
  endDate       DateTime? // 게시 종료일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 출력 이력 테이블
model PrintHistory {
  id            Int       @id @default(autoincrement())
  orderId       Int?      // 관련 주문
  orderNo       String    // 주문번호
  storeName     String    // 가맹점명
  printType     String    // 출력유형 (거래명세서, 출고명세서, 납품확인서)
  printedBy     String    // 출력자
  pageCount     Int       @default(1) // 페이지 수
  
  printedAt     DateTime  @default(now())
  
  @@index([orderId])
  @@index([printedAt])
}

// 묶음상품 테이블
model BundleProduct {
  id            Int       @id @default(autoincrement())
  name          String    // 묶음상품명
  description   String?   // 설명
  discountRate  Float     @default(0) // 묶음 할인율 (%)
  discountAmount Int      @default(0) // 묶음 할인액
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  items         BundleItem[]
}

// 묶음상품 구성 테이블
model BundleItem {
  id            Int       @id @default(autoincrement())
  bundleId      Int
  bundle        BundleProduct @relation(fields: [bundleId], references: [id])
  productId     Int
  quantity      Float     @default(1) // 수량 (안경렌즈: 0.5=한쪽)
  
  @@index([bundleId])
  @@index([productId])
}

// 상품 단축코드 테이블
model ProductShortcut {
  id            Int       @id @default(autoincrement())
  shortcode     String    @unique // 단축코드
  productId     Int       // 연결 상품
  description   String?   // 설명
  useCount      Int       @default(0) // 사용 횟수
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([productId])
}

// 배송 구역 테이블
model ShippingZone {
  id            Int       @id @default(autoincrement())
  name          String    // 구역명
  regions       String    // 지역 목록 (JSON array)
  baseFee       Int       @default(0) // 기본 배송비
  freeThreshold Int       @default(0) // 무료배송 기준금액
  extraFee      Int       @default(0) // 추가 배송비 (도서산간)
  deliveryDays  Int       @default(1) // 예상 배송일
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// 구분(카테고리) 설정 테이블
model Category {
  id            Int       @id @default(autoincrement())
  type          String    // 구분 타입 (optionType, productType, orderStatus 등)
  code          String    // 코드
  name          String    // 표시명
  description   String?   // 설명
  displayOrder  Int       @default(0) // 표시 순서
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([type, code])
  @@index([type])
}

// ===== 사용자 인증 테이블 =====
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  username      String    @unique
  password      String    // bcrypt 해시
  name          String    // 실명
  role          String    @default("user") // admin, manager, user
  
  // 권한 설정
  permissions   String?   // JSON array of permissions
  
  // 연결된 가맹점 (가맹점 계정인 경우)
  storeId       Int?
  
  // 상태
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  // passwordChangedAt DateTime?  // TODO: DB 마이그레이션 후 활성화
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([role])
  @@index([storeId])
}

// 세션 테이블 (NextAuth용)
model Session {
  id            Int       @id @default(autoincrement())
  sessionToken  String    @unique
  userId        Int
  expires       DateTime
  
  createdAt     DateTime  @default(now())
}

// 로그인 이력 테이블
model LoginHistory {
  id            Int       @id @default(autoincrement())
  userId        Int
  username      String
  ipAddress     String?
  userAgent     String?
  success       Boolean   @default(true)
  failReason    String?
  
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// ===== 재고 이동 이력 테이블 =====
model InventoryTransaction {
  id              Int       @id @default(autoincrement())
  productId       Int       // 상품 ID
  productOptionId Int?      // 상품옵션 ID (도수별 재고)
  
  type            String    // in: 입고, out: 출고, adjust: 조정, return: 반품입고
  reason          String    // purchase: 매입, sale: 판매, return: 반품, adjust: 재고조정, transfer: 이동
  
  quantity        Float     // 수량 (입고: +, 출고: -) (안경렌즈: 0.5=한쪽)
  beforeStock     Float     // 이동 전 재고
  afterStock      Float     // 이동 후 재고
  
  // 연관 정보
  orderId         Int?      // 관련 주문 ID
  orderNo         String?   // 관련 주문번호
  purchaseId      Int?      // 관련 매입 ID
  
  unitPrice       Int?      // 단가
  totalPrice      Int?      // 합계
  
  memo            String?
  processedBy     String?   // 처리자
  
  createdAt       DateTime  @default(now())
  
  @@index([productId])
  @@index([productOptionId])
  @@index([type])
  @@index([createdAt])
  @@index([orderId])
}

// ===== 반품 테이블 =====
model Return {
  id              Int       @id @default(autoincrement())
  returnNo        String    @unique // 반품번호
  orderId         Int       // 원주문 ID
  orderNo         String    // 원주문번호
  storeId         Int       // 가맹점 ID
  storeName       String
  
  status          String    @default("requested") // requested: 요청, approved: 승인, received: 입고, rejected: 거부
  type            String    @default("return") // return: 반품, exchange: 교환
  
  totalQuantity   Float     @default(0) // 총 수량 (안경렌즈: 0.5=한쪽)
  totalAmount     Int       @default(0)
  
  reason          String?   // 반품사유
  memo            String?
  
  requestedAt     DateTime  @default(now())
  approvedAt      DateTime?
  receivedAt      DateTime?
  processedBy     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items           ReturnItem[]
  
  @@index([orderId])
  @@index([storeId])
  @@index([status])
}

// 반품 상세
model ReturnItem {
  id              Int       @id @default(autoincrement())
  returnId        Int
  return          Return    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  
  orderItemId     Int       // 원주문 아이템 ID
  productId       Int
  productName     String
  optionName      String?
  
  quantity        Float     // 반품 수량 (안경렌즈: 0.5=한쪽)
  unitPrice       Int
  totalPrice      Int
  
  reason          String?   // 개별 사유
  condition       String?   // 상품 상태 (good: 양호, damaged: 파손, defective: 불량)
  
  createdAt       DateTime  @default(now())
  
  @@index([returnId])
  @@index([productId])
}

// ===== RX 검수 테이블 =====
model RxInspection {
  id              Int       @id @default(autoincrement())
  orderId         Int       // 주문 ID
  orderNo         String    // 주문번호
  orderItemId     Int       // 주문 상세 ID
  
  // 검수 상태
  status          String    @default("pending") // pending: 대기, passed: 합격, failed: 불합격, reprocess: 재가공
  
  // 처방값 검수
  sphOrdered      String?   // 주문 SPH
  cylOrdered      String?   // 주문 CYL
  axisOrdered     String?   // 주문 AXIS
  
  sphMeasured     String?   // 실측 SPH
  cylMeasured     String?   // 실측 CYL
  axisMeasured    String?   // 실측 AXIS
  
  // 허용 오차
  sphTolerance    Float     @default(0.12) // SPH 허용오차
  cylTolerance    Float     @default(0.12) // CYL 허용오차
  axisTolerance   Float     @default(3)    // AXIS 허용오차 (도)
  
  // 추가 검수 항목
  centerThickness Float?    // 중심두께
  edgeThickness   Float?    // 연변두께
  diameter        Float?    // 직경
  coating         String?   // 코팅 상태 (ok, scratch, bubble, peeling)
  tint            String?   // 착색 상태 (ok, uneven, light, dark)
  
  // 불합격 사유
  failReason      String?   // 불합격 사유
  failDetails     String?   // 상세 내용
  
  // 검수자 정보
  inspectedBy     String?   // 검수자
  inspectedAt     DateTime?
  
  // 재가공 정보
  reprocessCount  Int       @default(0)   // 재가공 횟수
  reprocessMemo   String?   // 재가공 메모
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([orderId])
  @@index([orderNo])
  @@index([status])
  @@index([inspectedAt])
}

// ===== SMS 발송 이력 테이블 =====
model SmsHistory {
  id              Int       @id @default(autoincrement())
  
  // 발송 대상
  phone           String    // 수신 전화번호
  storeId         Int?      // 가맹점 ID
  storeName       String?   // 가맹점명
  
  // 발송 내용
  templateId      Int?      // 템플릿 ID
  templateName    String?   // 템플릿명
  message         String    // 발송 메시지
  
  // 관련 정보
  orderId         Int?      // 관련 주문 ID
  orderNo         String?   // 관련 주문번호
  
  // 발송 상태
  status          String    @default("pending") // pending: 대기, sent: 발송완료, failed: 실패
  sendType        String    @default("sms")     // sms, lms, mms
  
  // 발송 결과
  resultCode      String?   // 결과 코드
  resultMessage   String?   // 결과 메시지
  sentAt          DateTime? // 발송 시간
  
  // 발송자
  sentBy          String?   // 발송자
  
  createdAt       DateTime  @default(now())
  
  @@index([phone])
  @@index([storeId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

// ===== SMS 템플릿 테이블 =====
model SmsTemplate {
  id              Int       @id @default(autoincrement())
  
  name            String    @unique // 템플릿명
  code            String    @unique // 템플릿 코드 (order_confirm, shipping, delivered 등)
  category        String    @default("general") // 카테고리 (order, shipping, payment, general)
  
  content         String    // 템플릿 내용
  // 치환 변수: {storeName}, {orderNo}, {productName}, {trackingNo}, {amount} 등
  
  isActive        Boolean   @default(true)
  isAuto          Boolean   @default(false) // 자동 발송 여부
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ===== 거래처별 브랜드 할인율 =====
model StoreBrandDiscount {
  id            Int       @id @default(autoincrement())
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  brandId       Int
  brand         Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  discountRate  Float     // 할인율 (%)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, brandId])
  @@index([storeId])
  @@index([brandId])
}

// ===== 거래처별 상품 할인율 =====
model StoreProductDiscount {
  id            Int       @id @default(autoincrement())
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId     Int
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  discountRate  Float     // 할인율 (%)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
}

// ===== 거래처별 상품 특수단가 =====
model StoreProductPrice {
  id            Int       @id @default(autoincrement())
  storeId       Int
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId     Int
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  specialPrice  Int       // 특수단가 (VAT포함)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
}

// =============================================================================
// 안경원 고객관리 시스템 (CRM)
// =============================================================================

// ===== 안경원 고객 =====
model Customer {
  id              Int       @id @default(autoincrement())
  storeId         Int       // 소속 안경원 (Store.id)
  
  // 기본 정보
  name            String    // 고객명
  phone           String    // 전화번호
  phone2          String?   // 보조 연락처
  email           String?   // 이메일
  birthDate       DateTime? // 생년월일
  gender          String?   // M: 남성, F: 여성
  
  // 주소
  zipcode         String?   // 우편번호
  address         String?   // 주소
  addressDetail   String?   // 상세주소
  
  // 메모/태그
  memo            String?   // 메모
  tags            String?   // 태그 (JSON array)
  
  // 마케팅 동의
  smsAgree        Boolean   @default(false)  // 문자 수신 동의
  emailAgree      Boolean   @default(false)  // 이메일 수신 동의
  
  // 방문 정보
  firstVisitAt    DateTime  @default(now())  // 첫 방문일
  lastVisitAt     DateTime?                   // 최근 방문일
  visitCount      Int       @default(1)       // 방문 횟수
  
  // 통계
  totalPurchase   Int       @default(0)       // 총 구매금액
  totalPoints     Int       @default(0)       // 적립 포인트
  usedPoints      Int       @default(0)       // 사용 포인트
  
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  prescriptions   CustomerPrescription[]
  purchases       CustomerPurchase[]
  reminders       CustomerReminder[]
  
  @@unique([storeId, phone])  // 같은 안경원 내 전화번호 중복 불가
  @@index([storeId])
  @@index([phone])
  @@index([name])
  @@index([lastVisitAt])
}

// ===== 고객 도수 기록 =====
model CustomerPrescription {
  id              Int       @id @default(autoincrement())
  customerId      Int
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // 측정일
  measuredAt      DateTime  @default(now())
  measuredBy      String?   // 검안사명
  
  // 우안 (OD - Right Eye)
  odSph           String?   // SPH (구면도수)
  odCyl           String?   // CYL (난시도수)
  odAxis          String?   // AXIS (난시축)
  odAdd           String?   // ADD (가입도수, 누진/이중초점용)
  odPd            String?   // PD (동공간 거리)
  odVa            String?   // VA (시력)
  odBc            String?   // BC (콘택트렌즈 기본커브)
  odDia           String?   // DIA (콘택트렌즈 직경)
  
  // 좌안 (OS - Left Eye)
  osSph           String?
  osCyl           String?
  osAxis          String?
  osAdd           String?
  osPd            String?
  osVa            String?
  osBc            String?
  osDia           String?
  
  // 양안 PD
  pdFar           String?   // 원거리 PD
  pdNear          String?   // 근거리 PD
  
  // 처방 유형
  prescType       String    @default("glasses") // glasses: 안경, contact: 콘택트, both: 둘다
  
  // 추가 정보
  dominantEye     String?   // 주시안 (OD/OS)
  occupation      String?   // 직업 (작업환경 참고용)
  hobbies         String?   // 취미 (렌즈 추천 참고용)
  
  // 기존 안경 정보
  currentGlasses  String?   // 현재 안경 정보
  wearingTime     String?   // 착용 시간 (종일, 근거리만, 운전시 등)
  
  // 특이사항
  complaints      String?   // 주요 불편사항
  eyeConditions   String?   // 눈 상태 (건조, 충혈 등)
  medicalHistory  String?   // 눈 관련 병력
  
  memo            String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([customerId])
  @@index([measuredAt])
}

// ===== 고객 구매 이력 =====
model CustomerPurchase {
  id              Int       @id @default(autoincrement())
  customerId      Int
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  storeId         Int       // 안경원 ID
  
  // 판매 정보
  saleNo          String    // 판매번호
  saleDate        DateTime  @default(now()) // 판매일
  
  // 금액
  totalAmount     Int       @default(0)     // 총 금액
  discountAmount  Int       @default(0)     // 할인금액
  finalAmount     Int       @default(0)     // 최종금액
  
  // 결제
  paymentMethod   String?   // cash, card, transfer, mixed
  cardAmount      Int       @default(0)     // 카드결제액
  cashAmount      Int       @default(0)     // 현금결제액
  pointsUsed      Int       @default(0)     // 사용 포인트
  pointsEarned    Int       @default(0)     // 적립 포인트
  
  // 배송 (택배인 경우)
  deliveryType    String    @default("pickup") // pickup: 매장수령, delivery: 배송
  deliveryStatus  String?   // pending, shipped, delivered
  trackingNo      String?   // 운송장번호
  
  // 연동 주문 (서울케미 주문 연결)
  linkedOrderId   Int?      // 서울케미 주문 ID
  linkedOrderNo   String?   // 서울케미 주문번호
  
  memo            String?
  salesPerson     String?   // 판매 담당자
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items           CustomerPurchaseItem[]
  
  @@index([customerId])
  @@index([storeId])
  @@index([saleDate])
  @@index([saleNo])
}

// ===== 고객 구매 상세 =====
model CustomerPurchaseItem {
  id              Int       @id @default(autoincrement())
  purchaseId      Int
  purchase        CustomerPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  
  // 상품 유형
  itemType        String    // frame: 안경테, lens: 렌즈, contact: 콘택트, accessory: 악세서리, service: 서비스
  
  // 상품 정보
  productId       Int?      // 서울케미 상품 ID (렌즈인 경우)
  productName     String    // 상품명
  brandName       String?   // 브랜드명
  modelName       String?   // 모델명
  
  // 도수 정보 (렌즈인 경우)
  eye             String?   // OD: 우안, OS: 좌안, OU: 양안
  sph             String?
  cyl             String?
  axis            String?
  add             String?
  
  // 안경테 정보 (테인 경우)
  frameColor      String?   // 색상
  frameSize       String?   // 사이즈
  
  // 금액
  quantity        Int       @default(1)
  unitPrice       Int       @default(0)     // 단가
  discountRate    Float     @default(0)     // 할인율
  discountAmount  Int       @default(0)     // 할인금액
  finalPrice      Int       @default(0)     // 최종가
  
  // 보증 정보
  warrantyMonths  Int       @default(0)     // 보증기간 (개월)
  warrantyExpiry  DateTime?                 // 보증만료일
  
  memo            String?
  
  createdAt       DateTime  @default(now())
  
  @@index([purchaseId])
  @@index([itemType])
}

// ===== 고객 리마인더/알림 =====
model CustomerReminder {
  id              Int       @id @default(autoincrement())
  customerId      Int
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  storeId         Int       // 안경원 ID
  
  // 리마인더 유형
  type            String    // checkup: 정기검안, birthday: 생일, warranty: 보증만료, custom: 커스텀
  
  // 내용
  title           String    // 제목
  message         String?   // 메시지 내용
  
  // 알림 일정
  scheduledAt     DateTime  // 알림 예정일
  remindDays      Int       @default(0) // 며칠 전 알림 (0: 당일)
  
  // 발송 상태
  status          String    @default("pending") // pending, sent, cancelled
  sentAt          DateTime?
  sentMethod      String?   // sms, email, kakao
  
  // 반복 설정
  isRecurring     Boolean   @default(false)
  recurringType   String?   // yearly: 매년 (생일), monthly: 매월
  
  memo            String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([customerId])
  @@index([storeId])
  @@index([scheduledAt])
  @@index([status])
}

// ===== 안경원 CRM 설정 =====
model CrmSettings {
  id              Int       @id @default(autoincrement())
  storeId         Int       @unique // 안경원 ID
  
  // 포인트 설정
  pointRate       Float     @default(1)     // 적립율 (%)
  pointMinPurchase Int      @default(10000) // 최소 구매금액
  pointExpireDays Int       @default(365)   // 포인트 유효기간 (일)
  
  // 리마인더 기본 설정
  checkupMonths   Int       @default(12)    // 정기검안 주기 (개월)
  checkupRemindDays Int     @default(7)     // 검안 리마인더 (며칠 전)
  birthdayRemindDays Int    @default(7)     // 생일 리마인더 (며칠 전)
  warrantyRemindDays Int    @default(30)    // 보증만료 리마인더 (며칠 전)
  
  // 문자 발송 설정
  smsEnabled      Boolean   @default(false)
  smsSignature    String?   // 문자 서명 (예: [행복안경원])
  
  // 영수증/인쇄 설정
  receiptHeader   String?   // 영수증 상단 문구
  receiptFooter   String?   // 영수증 하단 문구
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
