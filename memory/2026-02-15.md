# 2026-02-15 (토)

## 서울케미 웹앱 보안 강화 작업

### 완료된 작업

1. **JWT_SECRET 필수화**
   - 프로덕션 환경에서 JWT_SECRET 환경변수 없으면 에러 발생
   - 개발 환경에서는 fallback 사용 (dev-only-secret)
   - Vercel 환경변수에 JWT_SECRET 추가 완료

2. **로그인 실패 시 계정 잠금**
   - 5회 연속 실패 → 15분 잠금
   - `src/lib/auth.ts`에 `loginAttempts` Map으로 관리
   - 잠금 시 423 (Locked) 상태코드 반환
   - 남은 시간 표시

3. **비밀번호 변경 시 다른 세션 강제 로그아웃 (밀어내기)**
   - Prisma 스키마에 `passwordChangedAt` 필드 추가
   - 비밀번호 변경 시 이 필드 업데이트
   - JWT 검증 시 토큰 발급 시간 < passwordChangedAt이면 무효 처리
   - `src/app/api/auth/change-password/route.ts` 수정

4. **쿠키 보안 강화**
   - sameSite: 'lax' → 'strict' 변경

### 버그 수정

- **TypeScript 타입 에러**
  - `authenticateUser` 함수가 `AuthUser | null | { locked: true; remainingMin: number }` 반환
  - login/route.ts에서 `user.id` 접근 시 타입 에러 발생
  - `as AuthUser` 타입 캐스팅으로 해결

### 배포 상태
- Vercel 배포 성공 (31XoU9f5e)
- JWT_SECRET 환경변수 설정 완료

### 테스트 대기
- 오빠 로그인 후 전체 페이지 테스트 예정
  - 대시보드 Layout 적용 확인
  - 상품 > 브랜드 관리
  - 상품 > 재고 현황
  - 상품 > 재고 조정

---

## 담당자 데이터 마이그레이션 기능 (21:04)

### 추가된 기능
1. **"기존 데이터 가져오기" 버튼** (`/stores/delivery-staff`)
   - 담당자/그룹 관리 페이지 헤더에 버튼 추가
   - 미연결 데이터 있을 때만 파란색 버튼 표시
   - 마이그레이션 완료 시 "✅ 마이그레이션 완료" 표시

2. **마이그레이션 워크플로우**
   - 클릭 시 confirm 다이얼로그
   - `/api/migrate-staff` POST 호출
   - 결과 알림: 생성된 담당자 수 + 연결된 거래처 수 표시
   - 완료 후 자동 새로고침

3. **상태 체크**
   - 페이지 로드 시 `/api/migrate-staff` GET 호출
   - 미연결 데이터 있는지 확인
   - `migrationStatus` 상태로 관리

### 파일 수정
- `src/app/stores/delivery-staff/page.tsx`

### 배포 완료
- Vercel Production: https://seoulchemi-web.vercel.app

---

## 가맹점 등록 모달 UI 개선 (21:17)

### 변경사항
1. **섹션별 컬러 구분**
   - 📋 기본 정보: 파란색 (#007aff)
   - 🏢 사업자 정보: 주황색 (#ff9500)
   - 🤝 거래 정보: 초록색 (#34c759)

2. **폰트 크기 증가**
   - 섹션 헤더: 12px → 14px
   - fontWeight: 600 → 700
   - 섹션 구분선 추가 (borderBottom)

3. **초기 미수금 필드 추가**
   - `initialReceivables` 필드 Prisma 스키마 추가
   - 신규 등록 시 outstandingAmount 초기값으로 설정
   - 거래 정보 섹션에 입력 필드 추가

### 파일 수정
- `prisma/schema.prisma` - initialReceivables 필드 추가
- `src/app/stores/page.tsx` - 모달 UI 개선
- `src/app/api/stores/route.ts` - POST 핸들러 수정
- `src/app/api/stores/[id]/route.ts` - PATCH 핸들러 수정

---

## 프로젝트 정보
- **레포**: `C:\Users\User\clawd\mobile-glass`
- **GitHub**: bk00218-stack/seoulchemi-web
- **Vercel URL**: https://seoulchemi-web.vercel.app
